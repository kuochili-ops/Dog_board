<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Keyframe Tracker</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .stage { position: relative; cursor: crosshair; border: 2px solid #3498db; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        video { display: block; max-width: 100%; height: auto; }
        .dot { position: absolute; width: 10px; height: 10px; background: #ff4757; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; box-shadow: 0 0 5px rgba(0,0,0,0.8); }
        .controls { background: #2f3542; padding: 20px; border-radius: 12px; width: 100%; max-width: 800px; margin-top: 15px; }
        #log { white-space: pre-wrap; background: #1e2229; color: #2ed573; padding: 15px; margin-top: 15px; border: 1px solid #3d4451; height: 180px; overflow-y: auto; font-size: 13px; border-radius: 8px; }
        .btn-group { display: flex; gap: 10px; margin: 15px 0; }
        button { flex: 1; padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        .btn-save { background: #2ed573; color: #fff; }
        .btn-save:hover { background: #26af5f; }
        .btn-reset { background: #57606f; color: #fff; }
        .status-bar { display: flex; justify-content: space-between; font-size: 14px; color: #a4b0be; margin-bottom: 5px; }
        .highlight { color: #ffa502; font-weight: bold; }
    </style>
</head>
<body>

    <div class="stage" id="stage">
        <video id="v" controls playsinline>
            <source src="dog_board.mp4" type="video/mp4">
        </video>
    </div>

    <div class="controls">
        <div class="status-bar">
            <span>目前時間：<span id="timeDisplay" class="highlight">0.00</span>s</span>
            <span>當前點數：<span id="dotCount" class="highlight">0</span> / 4</span>
        </div>
        
        <div class="btn-group">
            <button class="btn-save" onclick="recordFrame()">儲存此影格數據</button>
            <button class="btn-reset" onclick="resetCurrentDots()">重選此影格</button>
        </div>

        <div id="log">尚未紀錄數據。請標註後按下儲存...</div>
    </div>

    <script>
        const stage = document.getElementById('stage');
        const video = document.getElementById('v');
        const log = document.getElementById('log');
        const timeDisplay = document.getElementById('timeDisplay');
        const dotCount = document.getElementById('dotCount');
        
        let currentDots = [];
        let allKeyframes = [];

        video.ontimeupdate = () => { 
            timeDisplay.innerText = video.currentTime.toFixed(2); 
        };

        stage.addEventListener('mousedown', function(e) {
            if (currentDots.length >= 4) return;
            
            // 點擊座標時，確保影片是暫停的
            video.pause();

            const rect = stage.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
            const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);
            
            currentDots.push({x, y});
            dotCount.innerText = currentDots.length;

            const div = document.createElement('div');
            div.className = 'dot';
            div.style.left = x + '%';
            div.style.top = y + '%';
            stage.appendChild(div);
        });

        function recordFrame() {
            if (currentDots.length < 4) {
                alert("請先點齊黑板的四個角（左上、右上、左下、右下）！");
                return;
            }
            
            const frameData = {
                time: parseFloat(video.currentTime.toFixed(2)),
                coords: {
                    lt: currentDots[0],
                    rt: currentDots[1],
                    lb: currentDots[2],
                    rb: currentDots[3]
                }
            };
            
            allKeyframes.push(frameData);
            // 依據時間排序，避免紀錄順序混亂
            allKeyframes.sort((a, b) => a.time - b.time);
            
            updateLog();
            resetCurrentDots();
        }

        function resetCurrentDots() {
            currentDots = [];
            dotCount.innerText = "0";
            document.querySelectorAll('.dot').forEach(d => d.remove());
        }

        function updateLog() {
            log.innerText = "請複製此 JSON 數據貼回給 AI：\n\n" + JSON.stringify(allKeyframes, null, 2);
        }
    </script>
</body>
</html>
