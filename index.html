<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Blackboard Sync</title>
    <style>
        body { background: #000; margin: 0; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; color: white; }
        .stage { position: relative; width: 100%; max-width: 800px; perspective: 1200px; overflow: hidden; }
        video { width: 100%; display: block; }

        /* 文字圖形層：透明底白色字圖形 */
        #textLayer {
            position: absolute;
            /* 定位於黑板最終停止時的中心點附近 */
            top: 54.5%; 
            left: 55%;
            width: 32%; 
            height: 42%;
            
            z-index: 10;
            pointer-events: none;
            
            /* 關鍵：旋轉支點必須精確鎖定在頂部邊緣中點，對齊吊繩 */
            transform-origin: center top; 
            
            /* 初始狀態：完全水平平放 (-90deg)，且背面隱藏 */
            transform: translate(-50%, 0) rotateX(-90deg);
            opacity: 0;
            
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform-style: preserve-3d;
            will-change: transform, opacity;
        }

        /* 根據影片 dog_board.mp4 的運動速度進行非線性校準 */
        @keyframes preciseFlip {
            0% {
                opacity: 0;
                transform: translate(-50%, -5%) rotateX(-90deg) rotateY(15deg);
            }
            /* 1.1s 到 1.4s 狗狗開始發力，黑板從背面轉向正面 */
            40% {
                opacity: 0; /* 翻轉未過 90 度前持續隱藏 */
                transform: translate(-50.5%, -4%) rotateX(-85deg) rotateY(16deg);
            }
            /* 1.5s 瞬間翻過 90 度，文字顯現並隨慣性向上 */
            55% {
                opacity: 1;
                transform: translate(-51.5%, -3%) rotateX(-45deg) rotateY(17deg) rotateZ(-3deg);
            }
            /* 2.2s 翻轉速度減緩，接近定點 */
            80% {
                opacity: 1;
                transform: translate(-53%, -1%) rotateX(-10deg) rotateY(15deg) rotateZ(-1deg);
            }
            /* 2.8s 最終定格位置 */
            100% {
                opacity: 1;
                transform: translate(-53.5%, 0%) rotateX(0deg) rotateY(13deg) rotateZ(0deg) scale(1.05);
            }
        }

        .animating {
            /* 使用 linear 確保與影片時間軸 1:1 同步，變速在 Keyframes 內部控制 */
            animation: preciseFlip 3.5s linear forwards;
        }

        .controls { padding: 20px; width: 100%; max-width: 400px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; font-size: 16px; }
        button { width: 100%; padding: 12px; background: #f1c40f; color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="stage">
        <video id="v" playsinline webkit-playsinline muted>
            <source src="dog_board.mp4" type="video/mp4">
        </video>
        <canvas id="textLayer"></canvas>
    </div>

    <div class="controls">
        <input type="text" id="userInput" placeholder="輸入文字訊息...">
        <button onclick="runSync()">同步加註</button>
    </div>

    <script>
        const canvas = document.getElementById('textLayer');
        const ctx = canvas.getContext('2d');
        const video = document.getElementById('v');
        const input = document.getElementById('userInput');

        function generateGraphic(text) {
            // 生成透明底、白色字的高解析圖案
            canvas.width = 512;
            canvas.height = 384;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "white";
            ctx.font = "900 64px sans-serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 5;
            
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        }

        function runSync() {
            generateGraphic(input.value || "同步測試");
            
            canvas.classList.remove('animating');
            video.pause();
            video.currentTime = 0;
            
            void canvas.offsetWidth; // 觸發 reflow
            
            video.play();
            canvas.classList.add('animating');
        }
    </script>
</body>
</html>
