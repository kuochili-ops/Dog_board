<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Manual Tracker</title>
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .stage { position: relative; cursor: crosshair; border: 2px solid #3498db; background: #000; line-height: 0; }
        video { display: block; max-width: 100%; height: auto; pointer-events: none; } /* 禁用影片直接點擊 */
        .dot { position: absolute; width: 10px; height: 10px; background: #ff4757; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; }
        .controls { background: #2f3542; padding: 20px; border-radius: 12px; width: 100%; max-width: 800px; margin-top: 15px; }
        #log { white-space: pre-wrap; background: #1e2229; color: #2ed573; padding: 15px; margin-top: 15px; border: 1px solid #3d4451; height: 150px; overflow-y: auto; font-size: 12px; border-radius: 8px; }
        .btn-group { display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        button { flex: 1; min-width: 120px; padding: 12px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; }
        .btn-play { background: #3498db; color: white; }
        .btn-save { background: #2ed573; color: white; }
        .btn-reset { background: #57606f; color: white; }
        .status { margin-bottom: 10px; color: #ffa502; font-weight: bold; }
    </style>
</head>
<body>

    <div class="status">目前秒數：<span id="timeDisplay">0.00</span>s | 點擊進度：<span id="dotCount">0</span> / 4</div>

    <div class="stage" id="stage">
        <video id="v" preload="auto">
            <source src="dog_board.mp4" type="video/mp4">
        </video>
    </div>

    <div class="controls">
        <div class="btn-group">
            <button class="btn-play" id="playBtn" onclick="togglePlay()">播放 / 暫停</button>
            <button class="btn-save" onclick="recordFrame()">紀錄此幀 (4點)</button>
            <button class="btn-reset" onclick="resetCurrentDots()">重選此幀</button>
        </div>
        <div id="log">請先點擊「播放/暫停」找到位置，暫停後依序點選四角。</div>
    </div>

    <script>
        const stage = document.getElementById('stage');
        const video = document.getElementById('v');
        const log = document.getElementById('log');
        const timeDisplay = document.getElementById('timeDisplay');
        const dotCount = document.getElementById('dotCount');
        
        let currentDots = [];
        let allKeyframes = [];

        function togglePlay() {
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }

        video.ontimeupdate = () => { 
            timeDisplay.innerText = video.currentTime.toFixed(2); 
        };

        // 監聽容器點擊，避開影片元件的預設行為
        stage.addEventListener('mousedown', function(e) {
            if (currentDots.length >= 4) return;
            
            // 開始點擊座標時，強制停止影片
            video.pause();

            const rect = stage.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(2);
            const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(2);
            
            currentDots.push({x, y});
            dotCount.innerText = currentDots.length;

            const div = document.createElement('div');
            div.className = 'dot';
            div.style.left = x + '%';
            div.style.top = y + '%';
            stage.appendChild(div);
        });

        function recordFrame() {
            if (currentDots.length < 4) {
                alert("請點滿四個角（左上、右上、左下、右下）再儲存。");
                return;
            }
            
            const frameData = {
                time: parseFloat(video.currentTime.toFixed(2)),
                coords: {
                    lt: currentDots[0],
                    rt: currentDots[1],
                    lb: currentDots[2],
                    rb: currentDots[3]
                }
            };
            
            allKeyframes.push(frameData);
            allKeyframes.sort((a, b) => a.time - b.time);
            
            log.innerText = "已儲存數據（請標註多個點後複製）：\n\n" + JSON.stringify(allKeyframes, null, 2);
            resetCurrentDots();
        }

        function resetCurrentDots() {
            currentDots = [];
            dotCount.innerText = "0";
            document.querySelectorAll('.dot').forEach(d => d.remove());
        }
    </script>
</body>
</html>
